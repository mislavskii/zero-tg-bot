import random
import telebot.version
import telebot
import traceback

import router as rt
import utils as ut

from auth import *

print('Hello, zerocoders!')
print('telebot version:', telebot.version.__version__)

bot = telebot.TeleBot(token)

# –°–ø–∏—Å–æ–∫ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ –ø—Ä–æ –±–æ—Ç–æ–≤
jokes = [
    "–í—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å –¥–≤–∞ –±–æ—Ç–∞. –û–¥–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç: '–ü—Ä–∏–≤–µ—Ç!', –∞ –¥—Ä—É–≥–æ–π –æ—Ç–≤–µ—á–∞–µ—Ç: '–¢—ã —É–∂–µ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏–ª.'",
    "–ß–µ–ª–æ–≤–µ–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –±–æ—Ç–∞: '–¢—ã —É–º–Ω—ã–π?' –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: '–î–∞, —è –∑–Ω–∞—é –≤—Å—ë! –°–ø—Ä–∞—à–∏–≤–∞–π, –ø–æ–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ –æ—Ç–∫–ª—é—á–∏–ª–∏.'",
    "–ë–æ—Ç: '–°–∫–∞–∂–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ.' –ß–µ–ª–æ–≤–µ–∫: '–¢—ã —Å–∞–º –±–æ—Ç, –ø—Ä–∏–¥—É–º–∞–π!'",
    "–ü–æ—á–µ–º—É –±–æ—Ç –Ω–µ –ø–æ—à–µ–ª –Ω–∞ —Å–≤–∏–¥–∞–Ω–∏–µ? –û–Ω –∑–∞–≤–∏—Å, –ø—ã—Ç–∞—è—Å—å –ø—Ä–∏–¥—É–º–∞—Ç—å, –∫–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.",
    "–ë–æ—Ç: '–¢—ã –º–µ–Ω—è –ª—é–±–∏—à—å?' –ß–µ–ª–æ–≤–µ–∫: '–ö–æ–Ω–µ—á–Ω–æ, —Ç—ã –∂–µ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å, —á–µ–≥–æ –Ω–µ —Å–∫–∞–∂–µ—à—å –ø—Ä–æ –ª—é–¥–µ–π.'"
]

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(
        message,
        """\
–ü—Ä–∏–≤–µ—Ç! –Ø —É–º–Ω—ã–π –±–æ—Ç! –í–æ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á—Ç–æ —è —É–º–µ—é:
- –ö–æ–º–∞–Ω–¥–∞ /help —Ä–∞—Å—Å–∫–∞–∂–µ—Ç, —á—Ç–æ —è —É–º–µ—é.
- –ö–æ–º–∞–Ω–¥–∞ /joke –∏–ª–∏ /–∞–Ω–µ–∫–¥–æ—Ç —Ä–∞—Å—Å–∫–∞–∂–µ—Ç —Ç–µ–±–µ –∞–Ω–µ–∫–¥–æ—Ç –ø—Ä–æ –±–æ—Ç–æ–≤.
- –ö–æ–º–∞–Ω–¥–∞ /coinflip –ø–æ–¥–±—Ä–∞—Å—ã–≤–∞–µ—Ç –º–æ–Ω–µ—Ç–∫—É.
- –ö–æ–º–∞–Ω–¥–∞ /roll6 –±—Ä–æ—Å–∞–µ—Ç —à–µ—Å—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫.
- –ö–æ–º–∞–Ω–¥–∞ /roll10 –±—Ä–æ—Å–∞–µ—Ç –¥–µ—Å—è—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫.
- –ö–æ–º–∞–Ω–¥–∞ /roll20 –±—Ä–æ—Å–∞–µ—Ç –¥–≤–∞–¥—Ü–∞—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫.
- –ê –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —è –µ–≥–æ –ø–æ–≤—Ç–æ—Ä—é! üòä\
"""
    )

# –ö–æ–º–∞–Ω–¥–∞ /help
@bot.message_handler(commands=['help'])
def send_help(message):
    bot.reply_to(
        message,
        """\
–í–æ—Ç —á—Ç–æ —è —É–º–µ—é:
- /start: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.
- /help: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
- /joke –∏–ª–∏ /–∞–Ω–µ–∫–¥–æ—Ç: –£—Å–ª—ã—à–∞—Ç—å —Å–º–µ—à–Ω–æ–π –∞–Ω–µ–∫–¥–æ—Ç –ø—Ä–æ –±–æ—Ç–æ–≤.
- /coinflip: –ü–æ–¥–±—Ä–æ—Å–∏—Ç—å –º–æ–Ω–µ—Ç–∫—É (–æ—Ä—ë–ª –∏–ª–∏ —Ä–µ—à–∫–∞).
- /roll6: –ë—Ä–æ—Å–∏—Ç—å —à–µ—Å—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫ (–æ—Ç 1 –¥–æ 6).
- /roll10: –ë—Ä–æ—Å–∏—Ç—å –¥–µ—Å—è—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫ (–æ—Ç 1 –¥–æ 10).
- /roll20: –ë—Ä–æ—Å–∏—Ç—å –¥–≤–∞–¥—Ü–∞—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫ (–æ—Ç 1 –¥–æ 20).
- –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –¥–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç!\
"""
    )

# –ö–æ–º–∞–Ω–¥–∞ /joke –∏ /–∞–Ω–µ–∫–¥–æ—Ç
@bot.message_handler(commands=['joke', '–∞–Ω–µ–∫–¥–æ—Ç'])
def send_joke(message):
    joke = random.choice(jokes)  # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç
    bot.reply_to(message, joke)

# –ö–æ–º–∞–Ω–¥–∞ /coinflip
@bot.message_handler(commands=['coinflip'])
def coinflip(message):
    result = random.choice(['–û—Ä—ë–ª', '–†–µ—à–∫–∞'])
    bot.reply_to(message, f"–ú–æ–Ω–µ—Ç–∫–∞ –ø–æ–¥–±—Ä–æ—à–µ–Ω–∞: {result}! ü™ô")

# –ö–æ–º–∞–Ω–¥–∞ /roll6
@bot.message_handler(commands=['roll6'])
def roll6(message):
    result = random.randint(1, 6)
    bot.reply_to(message, f"–®–µ—Å—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫: {result}! üé≤")

# –ö–æ–º–∞–Ω–¥–∞ /roll10
@bot.message_handler(commands=['roll10'])
def roll10(message):
    result = random.randint(1, 10)
    bot.reply_to(message, f"–î–µ—Å—è—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫: {result}! üé≤")

# –ö–æ–º–∞–Ω–¥–∞ /roll20
@bot.message_handler(commands=['roll20'])
def roll20(message):
    result = random.randint(1, 20)
    bot.reply_to(message, f"–î–≤–∞–¥—Ü–∞—Ç–∏–≥—Ä–∞–Ω–Ω—ã–π –∫—É–±–∏–∫: {result}! üé≤")

# –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∑–∞–¥–µ–π—Å—Ç–≤—É–µ–º —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ò–ò)
@bot.message_handler(func=lambda message: True)
def reply(message):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    preparation_message = bot.send_message(message.chat.id, "–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞...")
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    reply_text = rt.generate_ai_response(message.text)
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞..."
    bot.delete_message(message.chat.id, preparation_message.message_id)
    reply_chunks = ut.split_message(reply_text)
    # a text not exceeding TG's limit will be sent entirely in the first and only chunk
    for chunk in reply_chunks:   
        try:
            bot.send_message(message.chat.id, chunk)
        except Exception:
            traceback.print_exc()
            bot.send_message(message.chat.id, '–≠—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ –¥–ª—è –º–µ–Ω—è! –ü—Ä–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞...')

# @bot.message_handler(func=lambda message: True)
# def reply(message):
#     # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
#     preparation_message = bot.send_message(message.chat.id, "–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞...")
    
#     try:
#         # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
#         reply_text = rt.generate_ai_response(message.text)
#         reply_chunks = ut.split_message(reply_text)
        
#         # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞..."
#         bot.delete_message(message.chat.id, preparation_message.message_id)

#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —á–∞—Å—Ç—è–º–∏, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
#         for chunk in reply_chunks:
#             bot.send_message(message.chat.id, chunk)
#     except Exception:
#         # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞..."
#         bot.delete_message(message.chat.id, preparation_message.message_id)
        
#         # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
#         traceback.print_exc()
#         bot.send_message(message.chat.id, '–≠—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ –¥–ª—è –º–µ–Ω—è! –ü—Ä–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞...')

print('starting up!')

bot.infinity_polling()
